#!/usr/bin/env bash

set -e

# Determine original user and HOME
REAL_USER="$(logname 2>/dev/null || whoami)"
REAL_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)
[ -z "$REAL_HOME" ] && REAL_HOME="/home/$REAL_USER"
export HOME="$REAL_HOME"

echo "ℹ️  Running on behalf of: $REAL_USER"
echo "ℹ️  HOME directory set to: $HOME"

# Ensure HOME exists
if [ -z "$HOME" ] || [ ! -d "$HOME" ]; then
    echo "❌ HOME variable not set or directory does not exist!";
    exit 1;
fi

# Definitions
GITHUB_DIR="$HOME/GitHub"
AUTHOR="NikoboiNFTB"
AUTHOR_DIR="$GITHUB_DIR/$AUTHOR"
GIT_REPO="$AUTHOR_DIR/GitHub-Tools"
PROTON_REPO="$AUTHOR_DIR/Proton-VPN"
GP8_REPO="$AUTHOR_DIR/Guitar-Pro-On-Linux"
CODE_REPO="$AUTHOR_DIR/dev.nikoboi.code"

# Copy files
if [ "$(id -u)" -eq 0 ]; then
    # System-wide install for root
    cp "$GIT_REPO/shell/git/setup/automation" "/usr/bin/git-automation"
    cp "$GIT_REPO/shell/git/setup/workflow" "/usr/bin/git-workflow"
else
    # Copy into user's home repo

    # Remove folders
    rm -rf "$CODE_REPO/shell"

    # Create folders
    mkdir -p "$CODE_REPO/git"
    mkdir -p "$CODE_REPO/gp8"
    mkdir -p "$CODE_REPO/proton"
    mkdir -p "$CODE_REPO/utils"

    # GitHub-Tools/git/
    cp "$GIT_REPO/shell/git/setup/automation" "$CODE_REPO/git/automation"
    cp "$GIT_REPO/shell/git/setup/gh" "$CODE_REPO/git/gh"
    cp "$GIT_REPO/shell/git/setup/git" "$CODE_REPO/git/git"
    cp "$GIT_REPO/shell/git/setup/workflow" "$CODE_REPO/git/workflow"

    # GP8/
    cp "$GP8_REPO/install" "$CODE_REPO/gp8/install"

    # Proton/
    cp "$PROTON_REPO/install-icons" "$CODE_REPO/proton/install-icons"
    cp "$PROTON_REPO/setup" "$CODE_REPO/proton/setup"

    # GitHub-Tools/utils/
    cp "$GIT_REPO/shell/utils/compare" "$CODE_REPO/utils/compare"
    cp "$GIT_REPO/shell/utils/find-file" "$CODE_REPO/utils/find-file"
    cp "$GIT_REPO/shell/utils/find-.-filter-files" "$CODE_REPO/utils/find-.-filter-files"
    cp "$GIT_REPO/shell/utils/find-string" "$CODE_REPO/utils/find-string"
    cp "$GIT_REPO/shell/utils/sort" "$CODE_REPO/utils/sort"
    cp "$GIT_REPO/shell/utils/SORTME.txt" "$CODE_REPO/utils/SORTME.txt"
    cp "$GIT_REPO/shell/utils/sync" "$CODE_REPO/utils/sync"
fi
